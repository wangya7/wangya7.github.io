{"meta":{"title":"åŠè¾²","subtitle":"","description":"","author":"åŠè¾²","url":"http://bannong.wang","root":"/"},"pages":[],"posts":[{"title":"Dubbo-SPI&è‡ªé€‚åº”çš„æ‰©å±•æœºåˆ¶","slug":"Dubbo-SPI","date":"2020-12-03T13:51:44.000Z","updated":"2020-12-03T14:06:49.724Z","comments":true,"path":"2020/12/03/Dubbo-SPI/","link":"","permalink":"http://bannong.wang/2020/12/03/Dubbo-SPI/","excerpt":"","text":"META-INF/services ã€ServiceLoaderJDKçš„SPIæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚SPIå°†æ¥å£çš„å®ç°ç±»å…¨é™å®šåé…ç½®åœ¨æ–‡ä»¶ä¸­ï¼Œç”±æœåŠ¡åŠ è½½å™¨è¯»å–é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½å®ç°ç±»ï¼Œè¿™æ ·å¯ä»¥åœ¨è¿è¡ŒæœŸé—´åŠ¨æ€çš„æ›¿æ¢å®ç°ç±»ã€‚Dubboå®ç°äº†å¢å¼ºçš„SPIæœºåˆ¶ã€‚Dubboçš„SPIç›¸å…³é€»è¾‘è¢«å°è£…åœ¨ExtensionLoaderä¸­ï¼Œé€šè¿‡å…¶åŠ è½½æŒ‡å®šçš„å®ç°ç±»ã€‚ç›¸æ¯”äºJDKçš„è·¯å¾„ï¼ŒDubboå°†é…ç½®æ–‡ä»¶æ”¾ç½®åœ¨META-INF/dubbo è·¯å¾„ä¸‹ï¼ŒåŒæ—¶é‡‡ç”¨äº†é”®å€¼å¯¹çš„å½¢å¼ã€‚ å®˜æ–¹æ–‡æ¡£ SPIå’ŒDubboçš„è‡ªé€‚åº”çš„æ‰©å±•æœºåˆ¶å¿…é¡»æ”¾åœ¨ä¸€èµ·è¯´ï¼Œåˆ†ä¸å¼€çš„ã€‚ä¸»è¦åˆ†æ com.alibaba.dubbo.common.extension.ExtensionLoader case 1.ExtensionLoaderTest.robotTestä¸€ã€åˆå§‹åŒ–typeå¯¹åº”ExtensionLoaderå¯¹è±¡çš„objectFactoryæˆå‘˜å˜é‡1ExtensionLoader&lt;Robot&gt; extensionLoader = ExtensionLoader.getExtensionLoader(Robot.class); åŸºç¡€çš„åŒºåˆ«äºjdkçš„SPIåŠ è½½å®è·µé€šè¿‡ ExtensionLoader.getExtensionLoader(Robot.class); è¿™è¡Œä»£ç å°±å¿…é¡»èµ°åˆ° new ExtensionLoader(type)ã€‚å…¶å®è¿™1è¡Œä»£ç å°±æ˜¯è¯´åˆå§‹åŒ– ExtensionFactory çš„å®ç°ï¼Œé»˜è®¤æ˜¯é¦–å…ˆåŠ è½½ ExtensionFactory.class ç„¶åè°ƒç”¨äº† getAdaptiveExtension()è·å–è‡ªé€‚åº”æ‹“å±• 1com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtension è¿™ä¸ªæ–¹æ³•å°±æ˜¯æ ¸å¿ƒéœ€è¦ç†è§£çš„å•¦ã€‚ è°ƒç”¨ getAdaptiveExtensionClass æ–¹æ³•è·å–è‡ªé€‚åº”æ‹“å±• Class å¯¹è±¡ é€šè¿‡åå°„è¿›è¡Œå®ä¾‹åŒ– è°ƒç”¨ injectExtension æ–¹æ³•å‘æ‹“å±•å®ä¾‹ä¸­æ³¨å…¥ä¾èµ–æ¯ä¸ªæ­¥éª¤é‡Œé¢åˆç»†åˆ†ï¼Œå°¤å…¶æ˜¯ç¬¬ä¸€æ­¥æ¯”è¾ƒç²¾å½©ï¼è¿™é‡Œé¢æŠŠç¬¬1æ­¥æ‹¿å‡ºæ¥è¯´ä¸€ä¸‹ã€‚1234567891011121314151617181920212223/** * 1. è°ƒç”¨ getExtensionClasses è·å–æ‰€æœ‰çš„æ‹“å±•ç±» * 2. æ£€æŸ¥ç¼“å­˜ï¼Œè‹¥ç¼“å­˜ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›ç¼“å­˜ * 3. è‹¥ç¼“å­˜ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ createAdaptiveExtensionClass åˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±» * * * é¦–å…ˆä»ç¬¬ä¸€ä¸ªé€»è¾‘è¯´èµ·ï¼ŒgetExtensionClasses è¿™ä¸ªæ–¹æ³•ç”¨äºè·å–æŸä¸ªæ¥å£çš„æ‰€æœ‰å®ç°ç±»ã€‚æ¯”å¦‚è¯¥æ–¹æ³•å¯ä»¥è·å– * Protocol æ¥å£çš„ DubboProtocolã€HttpProtocolã€InjvmProtocol ç­‰å®ç°ç±»ã€‚åœ¨è·å–å®ç°ç±»çš„è¿‡ç¨‹ä¸­ï¼Œ * å¦‚æœæŸä¸ªå®ç°ç±»è¢« Adaptive æ³¨è§£ä¿®é¥°äº†ï¼Œé‚£ä¹ˆè¯¥ç±»å°±ä¼šè¢«èµ‹å€¼ç»™ cachedAdaptiveClass å˜é‡ã€‚æ­¤æ—¶ï¼Œä¸Šé¢æ­¥ * éª¤ä¸­çš„ç¬¬äºŒæ­¥æ¡ä»¶æˆç«‹ï¼ˆç¼“å­˜ä¸ä¸ºç©ºï¼‰ï¼Œç›´æ¥è¿”å› cachedAdaptiveClass å³å¯ã€‚å¦‚æœæ‰€æœ‰çš„å®ç°ç±»å‡æœªè¢« * Adaptive æ³¨è§£ä¿®é¥°ï¼Œé‚£ä¹ˆæ‰§è¡Œç¬¬ä¸‰æ­¥é€»è¾‘ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±»ã€‚ * * @return */private Class&lt;?&gt; getAdaptiveExtensionClass() &#123; // é€šè¿‡ SPI è·å–æ‰€æœ‰çš„æ‹“å±•ç±» getExtensionClasses(); if (cachedAdaptiveClass != null) &#123; return cachedAdaptiveClass; &#125; // åˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±» return cachedAdaptiveClass = createAdaptiveExtensionClass();&#125; è¿è¡Œä»£ç çš„æ—¶å€™ï¼Œä¼šå‘ç° ExtensionFactory åŒ…å«ä¸¤ä¸ªå®ç°ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªè¢« @Adaptive ä¿®é¥°çš„ AdaptiveExtensionFactoryï¼Œå…¶å®è¿™ä¸ªåœ¨getExtensionClasseså†…éƒ¨ä¼šåˆå§‹åŒ–èµ‹å€¼ç»™cachedAdaptiveClassï¼Œæ‰€ä»¥return cachedAdaptiveClass;ç›´æ¥è¿”å›å•¦ã€‚ äºŒã€typeå¯¹åº”ExtensionLoaderå¯¹è±¡è·å–å¯¹åº”åç§°çš„å®ä¾‹å¯¹è±¡1Robot optimusPrime = extensionLoader.getExtension(\"optimusPrime\"); è¿™ä¸ªå°±æ²¡æœ‰å•¥å­è¯´çš„å•¦ï¼Œè‡ªå·±è¿½ä»£ç  ç¬¬1ä¸ªcaseå°±æ˜¯é€šè¿‡ Class.forName åŠ è½½ æ²¡å•¥å¥½è¯´çš„ dubboé€šè¿‡è‡ªå®ç°çš„SPIæ¥å®ç°æ‰©å±•ï¼Œé…ç½®åˆ‡æ¢ã€‚ æ¯”å¦‚Protocolã€Clusterã€LoadBalance ç­‰ã€‚å½“æŸäº›æ‰©å±•ä¸æƒ³åœ¨æ¡†æ¶å¯åŠ¨æ—¶å€™åŠ è½½ï¼Œè€Œå¸Œæœ›æ‰©å±•æ–¹æ³•æ¡ç”¨çš„æ—¶å€™ï¼Œæ ¹æ®è¿è¡Œæ—¶å‚æ•°è¿›è¡ŒåŠ è½½ã€‚ â€”â€” æ‰©å±•æœªåŠ è½½ï¼Œéš¾é“å¯ä»¥ä½¿ç”¨æ‰©å±•çš„æ–¹æ³•ï¼Ÿdubboé€šè¿‡è‡ªé€‚åº”æ‹“å±•æœºåˆ¶å¾ˆå¥½çš„è§£å†³äº†ï¼Œdubbo ä¼šä¸ºæ‹“å±•æ¥å£ç”Ÿæˆå…·æœ‰ä»£ç†åŠŸèƒ½çš„ä»£ç ï¼Œç„¶åé€šè¿‡ javassist æˆ– jdk ç¼–è¯‘è¿™æ®µä»£ç å¾—åˆ°Classç±»ï¼Œæœ€åå†é€šè¿‡åå°„åˆ›å»ºä»£ç†ç±»ã€‚ @Adaptiveç”¨åœ¨ç±»ä¸Šé¢ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æ˜¾ç°ç±»ä½¿ç”¨ï¼Œè¿™ä¸ªå®ç°ç±»å°±æ˜¯è¿™ä¸ªæ¥å£çš„é»˜è®¤å®ç°ï¼ˆæ¯”å¦‚ä¸Šé¢è¯´çš„ AdaptiveExtensionFactoryï¼‰ï¼›ä½†æ˜¯è¿™ä¸ªæ³¨è§£å¤šæ•°ä½¿ç”¨åœ¨æ–¹æ³•ä¸Šã€‚ case 2.ExtensionLoader_Adaptive_Test.test_getAdaptiveExtension_injectè‡ªé€‚åº”åŠ è½½æµ‹è¯•å°¤å…¶éœ€è¦æ³¨æ„ urlå¢åŠ å‚æ•°çš„keyå’Œvalueã€‚è¿™éœ€è¦å’Œåˆ›å»ºè‡ªé€‚åº”çš„ä»£ç†ä»£ç æœ‰å…³ç³»ï¼Œå‚è€ƒè¿™ä¸ªæ–¹æ³•ã€‚ 1com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtensionClassCode å…¶å®å…¥å£ä¹Ÿæ˜¯ä¸Šé¢çš„createAdaptiveExtensionï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸Šé¢æ²¡æœ‰èµ°åˆ° createAdaptiveExtensionClassCode æ–¹æ³•å‘¢ï¼Ÿâ€”â€”â€”â€”æ˜¯å› ä¸ºä¸Šé¢çš„ ExtensionFactory çš„å®ç°ç±» AdaptiveExtensionFactory è¢« @Adaptive æ ‡æ³¨å•¦ã€‚ ä¸‹é¢å†é‡æ¸©è¿™æ®µä»£ç å§ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960/** * 1. è°ƒç”¨ getAdaptiveExtensionClass æ–¹æ³•è·å–è‡ªé€‚åº”æ‹“å±• Class å¯¹è±¡ * 2. é€šè¿‡åå°„è¿›è¡Œå®ä¾‹åŒ– * 3. è°ƒç”¨ injectExtension æ–¹æ³•å‘æ‹“å±•å®ä¾‹ä¸­æ³¨å…¥ä¾èµ– * @return */@SuppressWarnings(\"unchecked\")private T createAdaptiveExtension() &#123; try &#123; return injectExtension((T) getAdaptiveExtensionClass().newInstance()); &#125; catch (Exception e) &#123; throw new IllegalStateException(\"Can not create adaptive extension \" + type + \", cause: \" + e.getMessage(), e); &#125;&#125;/** * 1. è°ƒç”¨ getExtensionClasses è·å–æ‰€æœ‰çš„æ‹“å±•ç±» * 2. æ£€æŸ¥ç¼“å­˜ï¼Œè‹¥ç¼“å­˜ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›ç¼“å­˜ * 3. è‹¥ç¼“å­˜ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ createAdaptiveExtensionClass åˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±» * * * é¦–å…ˆä»ç¬¬ä¸€ä¸ªé€»è¾‘è¯´èµ·ï¼ŒgetExtensionClasses è¿™ä¸ªæ–¹æ³•ç”¨äºè·å–æŸä¸ªæ¥å£çš„æ‰€æœ‰å®ç°ç±»ã€‚æ¯”å¦‚è¯¥æ–¹æ³•å¯ä»¥è·å– * Protocol æ¥å£çš„ DubboProtocolã€HttpProtocolã€InjvmProtocol ç­‰å®ç°ç±»ã€‚åœ¨è·å–å®ç°ç±»çš„è¿‡ç¨‹ä¸­ï¼Œ * å¦‚æœæŸä¸ªå®ç°ç±»è¢« Adaptive æ³¨è§£ä¿®é¥°äº†ï¼Œé‚£ä¹ˆè¯¥ç±»å°±ä¼šè¢«èµ‹å€¼ç»™ cachedAdaptiveClass å˜é‡ã€‚æ­¤æ—¶ï¼Œä¸Šé¢æ­¥ * éª¤ä¸­çš„ç¬¬äºŒæ­¥æ¡ä»¶æˆç«‹ï¼ˆç¼“å­˜ä¸ä¸ºç©ºï¼‰ï¼Œç›´æ¥è¿”å› cachedAdaptiveClass å³å¯ã€‚å¦‚æœæ‰€æœ‰çš„å®ç°ç±»å‡æœªè¢« * Adaptive æ³¨è§£ä¿®é¥°ï¼Œé‚£ä¹ˆæ‰§è¡Œç¬¬ä¸‰æ­¥é€»è¾‘ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±»ã€‚ * * @return */private Class&lt;?&gt; getAdaptiveExtensionClass() &#123; // é€šè¿‡ SPI è·å–æ‰€æœ‰çš„æ‹“å±•ç±» getExtensionClasses(); if (cachedAdaptiveClass != null) &#123; return cachedAdaptiveClass; &#125; // åˆ›å»ºè‡ªé€‚åº”æ‹“å±•ç±» return cachedAdaptiveClass = createAdaptiveExtensionClass();&#125;private Class&lt;?&gt; createAdaptiveExtensionClass() &#123; // æ„å»ºè‡ªé€‚åº”æ‹“å±•ä»£ç  String code = createAdaptiveExtensionClassCode(); ClassLoader classLoader = findClassLoader(); // è·å–ç¼–è¯‘å™¨å®ç°ç±» com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension(); // ç¼–è¯‘ä»£ç ï¼Œç”Ÿæˆ Class return compiler.compile(code, classLoader);&#125;/** * çœ‹å®Œè¿™æ®µä»£ç å°±ç‚¹æ¯ å–œèŒ¶ * å…¶å®å¾ˆç®€å• æ‰¾ä¸ªæ¡ˆä¾‹è·‘ä¸€ä¸‹ æ¯”å¦‚ com.alibaba.dubbo.remoting.Transporter æˆ–è€… com.alibaba.dubbo.rpc.Protocol * * é»˜è®¤ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»çš„å­—ç¬¦ä¸²ç¼–ç  &#123;name&#125;$Adaptive * * @return */private String createAdaptiveExtensionClassCode() &#123; //...çœç•¥&#125; case 3.ExtensionLoader_Adaptive_Test.test_getAdaptiveExtension_customizeAdaptiveKeyäº†è§£åŠ è½½å‚æ•°çš„æ ·å¼ è¡¥å……ä¸€å¥ï¼Œè¿™é‡Œå°±å¯ä»¥çœ‹å‡ºæ¥URLçš„ä½œç”¨ ç›¸å½“äºæ•°æ®æ€»çº¿ ç©¿æ’åœ¨å„ä¸ªåŠŸèƒ½ç‚¹ é€šè¿‡å…¶ç»‘å®šç»‘å®šé…ç½®ä¿¡æ¯ æ€»ç»“ä¸€ä¸‹ å¯ä»¥å€Ÿé‰´çš„åœ°æ–¹å°±æ˜¯ åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ç«Ÿç„¶å¯ä»¥è¿™ä¹ˆç©ï¼Œæœ‰ç‚¹éªšï¼","categories":[],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"http://bannong.wang/tags/Dubbo/"},{"name":"Java","slug":"Java","permalink":"http://bannong.wang/tags/Java/"}]},{"title":"ä¸ªäººåšå®¢æ­å»º","slug":"Blog","date":"2020-06-18T08:31:44.753Z","updated":"2020-12-03T13:44:37.006Z","comments":true,"path":"2020/06/18/Blog/","link":"","permalink":"http://bannong.wang/2020/06/18/Blog/","excerpt":"","text":"ğŸ“°æœ¬åšå®¢é‡‡ç”¨Hexoï¼Œèµ„æºç›´æ¥æ‰˜ç®¡åœ¨Githubã€‚âš™ï¸å…³äºå¦‚æœæ“ä½œï¼ŒHexoå·²ç»æä¾›æ–‡æ¡£ï¼Œè‡ªå·±æœç´¢ğŸ”ä¹Ÿè¡Œï¼Œè¿™é¢æ¨ècofessä¸»é¢˜ä½œè€…çš„ä¸€ç¯‡æ–‡ç« ã€‚ å¤‡å¿˜å…³é”®æ“ä½œ1234567891011121314# hexo new \"æˆ‘çš„åšå®¢\"$ hexo n \"æˆ‘çš„åšå®¢\"# clean$ hexo clean# hexo generate ç”Ÿæˆé™æ€é¡µé¢$ hexo g# hexo server å¯åŠ¨æœåŠ¡é¢„è§ˆ$ hexo s# hexo deploy éƒ¨ç½²$ hexo d","categories":[],"tags":[]}],"categories":[],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"http://bannong.wang/tags/Dubbo/"},{"name":"Java","slug":"Java","permalink":"http://bannong.wang/tags/Java/"}]}